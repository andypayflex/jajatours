---
import AdminLayout from '@layouts/AdminLayout.astro';
import { getTestimonialById, updateTestimonial, deleteTestimonial } from '@db/queries/testimonials.js';
import { getAllTours } from '@db/queries/tours.js';
import { saveUpload } from '../../../db/uploads.js';
import { getImageUrl } from '@db/image.js';

const { id } = Astro.params;
let testimonial = getTestimonialById(id!);
if (!testimonial) return Astro.redirect('/admin/testimonials');

const tours = getAllTours();
let error = '';
let success = Astro.url.searchParams.get('saved') ? 'Saved.' : '';

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();

  if (form.get('_action') === 'delete') {
    deleteTestimonial(id!);
    return Astro.redirect('/admin/testimonials');
  }

  try {
    let customerPhoto = testimonial.customerPhoto;
    const photoFile = form.get('customerPhoto') as File | null;
    if (photoFile && photoFile.size > 0) {
      const upload = await saveUpload(photoFile);
      customerPhoto = upload.path;
    }

    updateTestimonial(id!, {
      customerName: form.get('customerName') as string,
      customerPhoto,
      quote: form.get('quote') as string,
      rating: parseInt(form.get('rating') as string) || 5,
      tourId: (form.get('tourId') as string) || undefined,
    });
    testimonial = getTestimonialById(id!)!;
    success = 'Updated.';
  } catch (e: any) {
    error = e.message;
  }
}

const photoUrl = getImageUrl(testimonial.customerPhoto);
---

<AdminLayout title={`Edit: ${testimonial.customerName}`}>
  <div class="admin-header">
    <h1>Edit Testimonial</h1>
    <a href="/admin/testimonials" class="btn btn-secondary">Back</a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}
  {success && <div class="alert alert-success">{success}</div>}

  <form method="POST" enctype="multipart/form-data" class="admin-card">
    <div class="form-grid">
      <div class="form-row">
        <div class="form-group">
          <label for="customerName">Customer Name *</label>
          <input type="text" id="customerName" name="customerName" value={testimonial.customerName} required />
        </div>
        <div class="form-group">
          <label for="rating">Rating *</label>
          <select id="rating" name="rating" required>
            {[5,4,3,2,1].map(n => <option value={n} selected={testimonial.rating === n}>{n} Star{n > 1 ? 's' : ''}</option>)}
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="quote">Quote *</label>
        <textarea id="quote" name="quote" rows="4" required>{testimonial.quote}</textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="customerPhoto">Customer Photo</label>
          {photoUrl && <img src={photoUrl} alt="" style="width:60px;height:60px;border-radius:50%;object-fit:cover;margin-bottom:0.5rem" />}
          <input type="file" id="customerPhoto" name="customerPhoto" accept="image/*" />
        </div>
        <div class="form-group">
          <label for="tourId">Tour</label>
          <select id="tourId" name="tourId">
            <option value="">None</option>
            {tours.map(t => <option value={t.id} selected={t.id === testimonial.tourId}>{t.title}</option>)}
          </select>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <a href="/admin/testimonials" class="btn btn-secondary">Cancel</a>
      </div>
    </div>
  </form>

  <form method="POST" style="margin-top:2rem" onsubmit="return confirm('Delete this testimonial?')">
    <input type="hidden" name="_action" value="delete" />
    <button type="submit" class="btn btn-danger">Delete</button>
  </form>
</AdminLayout>
