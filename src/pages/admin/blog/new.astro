---
import AdminLayout from '@layouts/AdminLayout.astro';
import { createBlogPost } from '@db/queries/blog.js';
import { saveUpload } from '../../../db/uploads.js';

let error = '';

if (Astro.request.method === 'POST') {
  try {
    const form = await Astro.request.formData();

    let mainImage: string | undefined;
    const imageFile = form.get('mainImage') as File | null;
    if (imageFile && imageFile.size > 0) {
      const upload = await saveUpload(imageFile);
      mainImage = upload.path;
    }

    const title = form.get('title') as string;
    const slug = (form.get('slug') as string) || title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

    const post = createBlogPost({
      title,
      slug,
      excerpt: (form.get('excerpt') as string) || undefined,
      body: (form.get('body') as string) || undefined,
      mainImage,
      mainImageAlt: (form.get('mainImageAlt') as string) || undefined,
    });
    return Astro.redirect(`/admin/blog/${post.id}?saved=1`);
  } catch (e: any) {
    error = e.message;
  }
}
---

<AdminLayout title="New Blog Post">
  <div class="admin-header">
    <h1>New Blog Post</h1>
    <a href="/admin/blog" class="btn btn-secondary">Back</a>
  </div>

  {error && <div class="alert alert-error">{error}</div>}

  <form method="POST" enctype="multipart/form-data" class="admin-card">
    <div class="form-grid">
      <div class="form-row">
        <div class="form-group">
          <label for="title">Title *</label>
          <input type="text" id="title" name="title" required />
        </div>
        <div class="form-group">
          <label for="slug">Slug</label>
          <input type="text" id="slug" name="slug" placeholder="Auto-generated" />
        </div>
      </div>
      <div class="form-group">
        <label for="excerpt">Excerpt</label>
        <textarea id="excerpt" name="excerpt" rows="2"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="mainImage">Main Image</label>
          <input type="file" id="mainImage" name="mainImage" accept="image/*" />
        </div>
        <div class="form-group">
          <label for="mainImageAlt">Image Alt Text</label>
          <input type="text" id="mainImageAlt" name="mainImageAlt" />
        </div>
      </div>
      <div class="form-group">
        <label for="body">Body (Markdown)</label>
        <textarea id="body" name="body" rows="15"></textarea>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">Create Post</button>
        <a href="/admin/blog" class="btn btn-secondary">Cancel</a>
      </div>
    </div>
  </form>
</AdminLayout>
