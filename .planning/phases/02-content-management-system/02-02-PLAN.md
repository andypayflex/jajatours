---
phase: 02-content-management-system
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/sanity/schemaTypes/blockContent.ts
  - src/sanity/schemaTypes/tour.ts
  - src/sanity/schemaTypes/blogPost.ts
  - src/sanity/schemaTypes/galleryImage.ts
  - src/sanity/schemaTypes/testimonial.ts
  - src/sanity/schemaTypes/index.ts
  - src/sanity/config.ts
autonomous: true

must_haves:
  truths:
    - "Guide sees Tours, Blog Posts, Gallery, and Testimonials as distinct content types in Studio"
    - "Guide can create a tour with title, slug, excerpt, main image, body, pricing, and available dates"
    - "Guide can write a blog post with rich text formatting and embedded images"
    - "Guide can upload gallery photos with alt text, caption, and tour reference"
    - "Guide can add testimonials with customer name, photo, quote, rating, and tour reference"
    - "All required fields show validation errors when empty, preventing incomplete content"
  artifacts:
    - path: "src/sanity/schemaTypes/blockContent.ts"
      provides: "Reusable Portable Text rich content type"
      contains: "defineType"
    - path: "src/sanity/schemaTypes/tour.ts"
      provides: "Tour document schema with pricing, dates, and images"
      contains: "name: 'tour'"
    - path: "src/sanity/schemaTypes/blogPost.ts"
      provides: "Blog post document schema with body and author"
      contains: "name: 'blogPost'"
    - path: "src/sanity/schemaTypes/galleryImage.ts"
      provides: "Gallery image document schema with optimization metadata"
      contains: "name: 'galleryImage'"
    - path: "src/sanity/schemaTypes/testimonial.ts"
      provides: "Testimonial document schema with rating and tour reference"
      contains: "name: 'testimonial'"
    - path: "src/sanity/schemaTypes/index.ts"
      provides: "Central schema export registering all document types"
      contains: "schemaTypes"
  key_links:
    - from: "src/sanity/schemaTypes/tour.ts"
      to: "src/sanity/schemaTypes/blockContent.ts"
      via: "body field references blockContent type"
      pattern: "type: 'blockContent'"
    - from: "src/sanity/schemaTypes/blogPost.ts"
      to: "src/sanity/schemaTypes/blockContent.ts"
      via: "body field references blockContent type"
      pattern: "type: 'blockContent'"
    - from: "src/sanity/schemaTypes/testimonial.ts"
      to: "src/sanity/schemaTypes/tour.ts"
      via: "tour reference field"
      pattern: "type: 'reference'.*type: 'tour'"
    - from: "src/sanity/schemaTypes/galleryImage.ts"
      to: "src/sanity/schemaTypes/tour.ts"
      via: "tour reference field"
      pattern: "type: 'reference'.*type: 'tour'"
    - from: "src/sanity/config.ts"
      to: "src/sanity/schemaTypes/index.ts"
      via: "schema types registration in Studio config"
      pattern: "schema.*types"
---

<objective>
Create all content schemas (tour, blog post, gallery image, testimonial) with proper validation, and configure Sanity Studio's desk structure so the guide sees content organized by type.

Purpose: Content schemas define what the guide can create and edit. Without schemas, the CMS has no content types. Proper validation ensures content quality without developer oversight.
Output: Five schema files, a schema index, and Studio configuration with organized desk structure.
</objective>

<execution_context>
@/Users/andydev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andydev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-management-system/02-RESEARCH.md
@.planning/phases/02-content-management-system/02-01-SUMMARY.md

# Schema patterns from research
# Tour schema: title, slug, excerpt, mainImage (hotspot), body (blockContent), pricing (amount/currency/perPerson), availableDates (date/spots), publishedAt
# Blog schema: title, slug, excerpt, mainImage, body (blockContent), publishedAt
# Gallery schema: image (hotspot), alt, caption, tour reference, publishedAt
# Testimonial schema: customerName, customerPhoto, quote, rating (1-5), tour reference, publishedAt
# BlockContent: rich text with h2/h3/blockquote styles, strong/em decorators, links, inline images
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create blockContent, tour, and blogPost schemas</name>
  <files>src/sanity/schemaTypes/blockContent.ts, src/sanity/schemaTypes/tour.ts, src/sanity/schemaTypes/blogPost.ts</files>
  <action>
**1. Create `src/sanity/schemaTypes/blockContent.ts`** — reusable rich text type:
Use `defineType` and `defineArrayMember` from 'sanity'.
- Type name: 'blockContent', type: 'array'
- Block styles: Normal, H2, H3, Blockquote
- Mark decorators: Strong, Emphasis
- Mark annotations: External link (with href url field)
- Array member: image type with hotspot, alt (required), and caption fields

**2. Create `src/sanity/schemaTypes/tour.ts`** — tour document:
Use `defineType` and `defineField` from 'sanity'.
- Document name: 'tour', title: 'Tour'
- Fields:
  - `title`: string, required, error message "Please add a tour title"
  - `slug`: slug from title, maxLength 96, required
  - `excerpt`: text, 3 rows, max 200 chars warning for SEO, description "Short description for tour listings and SEO"
  - `mainImage`: image with hotspot, alt text required for accessibility
  - `body`: blockContent type
  - `category`: string with list options ['Overlanding', 'Diving', 'Rafting', 'Camping', 'Adventure'], description "Tour category"
  - `duration`: string, description "e.g. '3 days / 2 nights'"
  - `groupSize`: object with `min` (number) and `max` (number) fields
  - `pricing`: object with `amount` (number, required, min 0), `currency` (string, list ['ZAR', 'USD', 'EUR'], initialValue 'ZAR'), `perPerson` (boolean, initialValue true)
  - `availableDates`: array of objects with `date` (date), `spotsAvailable` (number, min 0)
  - `publishedAt`: datetime, initialValue current ISO string
- Preview: select title, media from mainImage, subtitle from pricing.amount. prepare() shows "R{amount}" or "No price set"

**3. Create `src/sanity/schemaTypes/blogPost.ts`** — blog post document:
- Document name: 'blogPost', title: 'Blog Post'
- Fields:
  - `title`: string, required
  - `slug`: slug from title, maxLength 96, required
  - `excerpt`: text, 3 rows, max 160 chars warning for SEO
  - `mainImage`: image with hotspot, alt text required
  - `body`: blockContent type, required with warning "A blog post needs content"
  - `publishedAt`: datetime, initialValue current ISO string
- Preview: select title, media from mainImage, subtitle from publishedAt
- Ordering: publishedAt desc

Use descriptive field descriptions where helpful for a non-technical guide (e.g., "This appears in search results and social media previews").
  </action>
  <verify>
Verify all three files exist and export default defineType(...) with correct names.
Verify tour schema has all required fields: title, slug, excerpt, mainImage, body, category, duration, groupSize, pricing, availableDates, publishedAt.
Verify blogPost schema has: title, slug, excerpt, mainImage, body, publishedAt.
Verify blockContent has block styles, decorators, annotations, and image member.
Run TypeScript check: `npx tsc --noEmit` (may have errors from missing schema registration, but individual files should parse).
  </verify>
  <done>Three schema files created with proper field definitions, validation rules, and user-friendly descriptions. Tour has pricing/dates/categories. Blog has rich text body. Both reference blockContent for rich text.</done>
</task>

<task type="auto">
  <name>Task 2: Create galleryImage and testimonial schemas, schema index, and Studio config</name>
  <files>src/sanity/schemaTypes/galleryImage.ts, src/sanity/schemaTypes/testimonial.ts, src/sanity/schemaTypes/index.ts, src/sanity/config.ts</files>
  <action>
**1. Create `src/sanity/schemaTypes/galleryImage.ts`** — gallery image document:
- Document name: 'galleryImage', title: 'Gallery Image'
- Fields:
  - `image`: image type, required, with hotspot enabled
  - `alt`: string, required, title 'Alt Text', description "Describe the image for accessibility"
  - `caption`: string, description "Optional caption displayed below the image"
  - `tour`: reference to 'tour' type, description "Which tour is this photo from?"
  - `tags`: array of strings, description "Tags for filtering (e.g., 'diving', 'landscape', 'group')"
  - `publishedAt`: datetime, initialValue current ISO string
- Preview: select title from alt, media from image, subtitle from caption

**2. Create `src/sanity/schemaTypes/testimonial.ts`** — testimonial document:
Follow the research pattern exactly:
- Document name: 'testimonial', title: 'Testimonial'
- Fields:
  - `customerName`: string, required
  - `customerPhoto`: image with hotspot, alt field
  - `quote`: text, 4 rows, required, max 500 chars
  - `rating`: number, required, min 1, max 5, integer, with list options for 1-5 stars
  - `tour`: reference to 'tour' type, description "Which tour is this testimonial about?"
  - `publishedAt`: datetime, initialValue current ISO string
- Preview: select title from customerName, media from customerPhoto, subtitle from quote (truncated)

**3. Create `src/sanity/schemaTypes/index.ts`** — central schema export:
```typescript
import tour from './tour';
import blogPost from './blogPost';
import galleryImage from './galleryImage';
import testimonial from './testimonial';
import blockContent from './blockContent';

export const schemaTypes = [tour, blogPost, galleryImage, testimonial, blockContent];
```

**4. Update `src/sanity/config.ts`** — add schema types and desk structure to Studio config:
The `@sanity/astro` integration uses a `sanity.config.ts` (or the config exported from src/sanity/config.ts). Update the existing config to include:
- Import `defineConfig` from 'sanity'
- Import `structureTool` from 'sanity/structure' (replaces deprecated deskTool)
- Import `visionTool` from '@sanity/vision'
- Import `schemaTypes` from './schemaTypes'
- Export a `defineConfig({...})` that includes:
  - projectId, dataset, apiVersion from env vars
  - plugins: [structureTool({ structure: customStructure }), visionTool()]
  - schema: { types: schemaTypes }

Create a custom desk structure function that organizes content into:
- Tours (filter _type == 'tour')
- Blog Posts (filter _type == 'blogPost')
- Gallery (filter _type == 'galleryImage')
- Testimonials (filter _type == 'testimonial')

The config.ts file now serves dual purpose: exports raw config values for the client AND exports a defineConfig for Studio. Keep the existing `sanityConfig` export for use by client.ts, and add a separate `studioConfig` export using `defineConfig()`.

Important: Use `structureTool` (from 'sanity/structure'), NOT `deskTool` which is deprecated in Sanity v4.
  </action>
  <verify>
Verify all five schema files exist in src/sanity/schemaTypes/.
Verify src/sanity/schemaTypes/index.ts imports and exports all 5 schemas.
Verify src/sanity/config.ts exports both sanityConfig (raw values) and studioConfig (defineConfig).
Run `npx tsc --noEmit` — should pass or show only non-blocking warnings.
Run `npm run build` — should complete successfully.
  </verify>
  <done>All 5 content schemas created with validation. Schema index exports all types. Studio config registers schemas with organized desk structure showing Tours, Blog Posts, Gallery, and Testimonials as separate sections. Build passes.</done>
</task>

</tasks>

<verification>
1. All 5 schema files exist in `src/sanity/schemaTypes/`
2. Schema index (`src/sanity/schemaTypes/index.ts`) exports array of all 5 types
3. Tour schema has: title, slug, excerpt, mainImage, body, category, duration, groupSize, pricing, availableDates, publishedAt
4. Blog post schema has: title, slug, excerpt, mainImage, body, publishedAt
5. Gallery image schema has: image, alt, caption, tour reference, tags, publishedAt
6. Testimonial schema has: customerName, customerPhoto, quote, rating, tour reference, publishedAt
7. BlockContent has: block (h2/h3/blockquote), strong/em, links, images
8. Studio config registers all schema types and has organized desk structure
9. `npm run build` passes
</verification>

<success_criteria>
- Guide would see 4 distinct content types in Studio sidebar: Tours, Blog Posts, Gallery, Testimonials
- Each content type has all required fields with validation preventing incomplete content
- Tour pricing uses structured fields (amount/currency/perPerson) not free text
- Rich text (blockContent) supports headings, bold, italic, links, and images
- Testimonials and gallery images reference tours for cross-linking
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-management-system/02-02-SUMMARY.md`
</output>
