---
phase: 02-content-management-system
plan: 03
type: execute
wave: 3
depends_on: ["02-01", "02-02"]
files_modified:
  - src/sanity/lib/queries.ts
  - src/components/PortableText.astro
  - src/components/PortableTextImage.astro
  - netlify.toml
autonomous: false

must_haves:
  truths:
    - "GROQ queries can fetch all tours, blog posts, gallery images, and testimonials"
    - "Portable Text content renders as formatted HTML with headings, bold, italic, links, and images"
    - "Netlify rebuilds automatically when content is published in Sanity"
    - "Guide can log into Sanity Studio and see organized content types"
    - "Guide can create and publish a tour entry with all required fields"
  artifacts:
    - path: "src/sanity/lib/queries.ts"
      provides: "Centralized GROQ query definitions for all content types"
      contains: "allToursQuery"
    - path: "src/components/PortableText.astro"
      provides: "Astro component for rendering Sanity rich text"
      contains: "PortableText"
    - path: "src/components/PortableTextImage.astro"
      provides: "Custom image renderer for Portable Text embedded images"
      contains: "urlForImage"
  key_links:
    - from: "src/sanity/lib/queries.ts"
      to: "src/sanity/schemaTypes/tour.ts"
      via: "GROQ queries reference tour document type and fields"
      pattern: "_type == \"tour\""
    - from: "src/sanity/lib/queries.ts"
      to: "src/sanity/schemaTypes/blogPost.ts"
      via: "GROQ queries reference blogPost document type"
      pattern: "_type == \"blogPost\""
    - from: "src/components/PortableText.astro"
      to: "src/components/PortableTextImage.astro"
      via: "registers PortableTextImage as custom type handler"
      pattern: "PortableTextImage"
    - from: "src/components/PortableTextImage.astro"
      to: "src/sanity/lib/image.ts"
      via: "uses urlForImage to generate optimized image URLs"
      pattern: "urlForImage"
---

<objective>
Create the GROQ query layer, Portable Text rendering components, and Netlify webhook configuration. Then verify the complete CMS workflow with the guide.

Purpose: Queries and rendering components bridge Sanity content to Astro pages. The webhook ensures content changes trigger automatic rebuilds. Verification confirms the guide can actually use the system end-to-end.
Output: Query definitions, PortableText components, webhook config, and verified CMS workflow.
</objective>

<execution_context>
@/Users/andydev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andydev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-management-system/02-RESEARCH.md
@.planning/phases/02-content-management-system/02-01-SUMMARY.md
@.planning/phases/02-content-management-system/02-02-SUMMARY.md

# Key dependencies from prior plans
@src/sanity/lib/client.ts
@src/sanity/lib/image.ts
@src/sanity/schemaTypes/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GROQ queries for all content types</name>
  <files>src/sanity/lib/queries.ts</files>
  <action>
Create `src/sanity/lib/queries.ts` with centralized GROQ query definitions.

Import `groq` from '@sanity/client' (or define as template literal tag if not available — check @sanity/client exports).

**Tour queries:**
- `allToursQuery`: Fetch all published tours ordered by publishedAt desc. Project: _id, title, slug, excerpt, mainImage, pricing, category, duration, publishedAt. Filter out drafts with `!(_id in path("drafts.**"))`.
- `tourBySlugQuery`: Fetch single tour by $slug parameter. Project all fields plus expanded body. Include `"slug": slug.current` for convenience.

**Blog post queries:**
- `allBlogPostsQuery`: Fetch all published blog posts ordered by publishedAt desc. Project: _id, title, slug, excerpt, mainImage, publishedAt.
- `blogPostBySlugQuery`: Fetch single post by $slug. Project all fields.

**Gallery queries:**
- `allGalleryImagesQuery`: Fetch all gallery images ordered by publishedAt desc. Project: _id, image, alt, caption, tags, publishedAt, `"tourTitle": tour->title`.
- `galleryImagesByTourQuery`: Fetch gallery images for a specific tour via $tourId parameter.

**Testimonial queries:**
- `allTestimonialsQuery`: Fetch all testimonials ordered by publishedAt desc. Project: _id, customerName, customerPhoto, quote, rating, publishedAt, `"tourTitle": tour->title, "tourSlug": tour->slug.current`.
- `testimonialsByTourQuery`: Fetch testimonials for a specific tour via $tourId parameter.

All queries must:
- Filter out drafts: `!(_id in path("drafts.**"))`
- Use projections (don't fetch entire documents)
- Use query parameters ($slug, $tourId) not string interpolation
- Be exported as named constants
  </action>
  <verify>
Verify `src/sanity/lib/queries.ts` exists and exports all 8 query constants.
Verify all queries use draft filtering.
Verify all queries use projections (not `*[_type == "tour"]` without field selection).
Run `npx tsc --noEmit` to verify TypeScript validity.
  </verify>
  <done>8 GROQ queries exported covering all 4 content types (tours, blog posts, gallery images, testimonials) with listing and detail variants. All queries filter drafts and use precise projections.</done>
</task>

<task type="auto">
  <name>Task 2: Create Portable Text components and configure Netlify webhook</name>
  <files>src/components/PortableText.astro, src/components/PortableTextImage.astro, netlify.toml</files>
  <action>
**1. Create `src/components/PortableTextImage.astro`** — custom image renderer for Portable Text:
```astro
---
import { urlForImage } from '../sanity/lib/image';

interface Props {
  node: {
    asset: { _ref: string };
    alt?: string;
    caption?: string;
  };
}

const { node } = Astro.props;
const imageUrl = urlForImage(node).width(800).url();
---

<figure>
  <img src={imageUrl} alt={node.alt || ''} loading="lazy" width="800" />
  {node.caption && <figcaption>{node.caption}</figcaption>}
</figure>
```

**2. Create `src/components/PortableText.astro`** — wrapper component:
Use `astro-portabletext` package. Import `PortableText` component from 'astro-portabletext'.
Register PortableTextImage as the handler for 'image' type nodes.

```astro
---
import { PortableText as PT } from 'astro-portabletext';
import PortableTextImage from './PortableTextImage.astro';

interface Props {
  value: any[];
}

const { value } = Astro.props;

const components = {
  type: {
    image: PortableTextImage,
  },
};
---

<div class="portable-text">
  <PT value={value} components={components} />
</div>
```

Check the `astro-portabletext` documentation for the exact component API. The `components` prop structure may use `type` (singular) not `types` — verify against the package API. If the package uses a different prop name for custom type handlers, adjust accordingly.

**3. Update `netlify.toml`** — add build hook documentation comment:
Add a comment section at the top of netlify.toml explaining that a Sanity webhook should be configured to trigger builds. The actual webhook URL is created in the Netlify dashboard (Settings -> Build & deploy -> Build hooks) and configured in Sanity (Manage -> API -> Webhooks).

Do NOT add the actual webhook URL to the file (it's a secret). Add a comment block:
```toml
# Sanity CMS Webhook Integration
# To enable automatic rebuilds when content changes:
# 1. Netlify: Site settings -> Build & deploy -> Build hooks -> Add build hook (name: "Sanity Publish")
# 2. Sanity: sanity.io/manage -> [Project] -> API -> Webhooks -> Add webhook
#    - URL: paste the Netlify build hook URL
#    - Dataset: production
#    - Filter: _type in ["tour", "blogPost", "galleryImage", "testimonial"]
#    - Trigger on: Create, Update, Delete
```

Add this comment block at the top of netlify.toml, before the existing [build] section.
  </action>
  <verify>
Verify `src/components/PortableText.astro` and `src/components/PortableTextImage.astro` exist.
Verify PortableText.astro imports from 'astro-portabletext'.
Verify PortableTextImage.astro uses urlForImage from the sanity image helper.
Verify netlify.toml has webhook documentation comment.
Run `npm run build` — build passes.
  </verify>
  <done>PortableText rendering pipeline complete with custom image handling. Netlify webhook integration documented. Build passes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Sanity CMS integration with:
- Sanity Studio accessible at the /studio route (via @sanity/astro)
- 4 content types: Tours, Blog Posts, Gallery Images, Testimonials
- Organized desk structure in Studio
- GROQ queries for all content types
- Portable Text rendering components
- Netlify webhook documentation
  </what-built>
  <how-to-verify>
1. Ensure `.env` has valid `PUBLIC_SANITY_PROJECT_ID` and `PUBLIC_SANITY_DATASET` values
2. Run `npm run dev` and navigate to `http://localhost:4321/studio`
3. Verify you can see 4 content sections: Tours, Blog Posts, Gallery, Testimonials
4. Create a test tour:
   - Fill in title, generate slug, add excerpt
   - Upload a main image
   - Set pricing (e.g., R500 ZAR per person)
   - Add an available date
   - Click Publish
5. Create a test blog post:
   - Fill in title, generate slug
   - Write some body text with a heading, bold text, and a link
   - Click Publish
6. Create a test gallery image:
   - Upload a photo, add alt text and caption
   - Reference the test tour
   - Click Publish
7. Create a test testimonial:
   - Add customer name and quote
   - Set a rating (1-5)
   - Reference the test tour
   - Click Publish
8. Verify all content appears in their respective sections

If any step fails, describe what went wrong.
  </how-to-verify>
  <resume-signal>Type "approved" if CMS works correctly, or describe issues encountered.</resume-signal>
</task>

</tasks>

<verification>
1. `src/sanity/lib/queries.ts` exports 8 GROQ queries for all content types
2. `src/components/PortableText.astro` renders rich text with custom image handling
3. `netlify.toml` has webhook setup documentation
4. `npm run build` passes
5. Guide can access Studio at /studio and see organized content types
6. Guide can create and publish all 4 content types
</verification>

<success_criteria>
- All GROQ queries defined and typed for tours, blog posts, gallery images, testimonials
- Portable Text renders formatted content with embedded images
- Netlify webhook integration documented for automatic rebuilds
- Guide has verified they can log in, create content, and publish in all 4 content types
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-management-system/02-03-SUMMARY.md`
</output>
