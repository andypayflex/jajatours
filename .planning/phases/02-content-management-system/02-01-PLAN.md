---
phase: 02-content-management-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - astro.config.mjs
  - .env
  - .env.example
  - src/sanity/config.ts
  - src/sanity/lib/client.ts
  - src/sanity/lib/image.ts
autonomous: true
user_setup:
  - service: sanity
    why: "Headless CMS for content management"
    env_vars:
      - name: PUBLIC_SANITY_PROJECT_ID
        source: "Create project at sanity.io/manage -> Project ID on project settings page"
      - name: PUBLIC_SANITY_DATASET
        source: "Usually 'production' — set during project creation at sanity.io/manage"
    dashboard_config:
      - task: "Create a Sanity project"
        location: "sanity.io/manage -> Create new project"
      - task: "Add CORS origin for localhost:4321"
        location: "sanity.io/manage -> [Project] -> API -> CORS origins -> Add http://localhost:4321 with Allow credentials"

must_haves:
  truths:
    - "Sanity packages are installed and importable"
    - "Astro integration is configured with correct project ID and dataset"
    - "Sanity client can connect to the project's content lake"
    - "Image URL builder generates valid Sanity CDN URLs"
  artifacts:
    - path: "src/sanity/config.ts"
      provides: "Centralized Sanity configuration (projectId, dataset, apiVersion)"
      contains: "projectId"
    - path: "src/sanity/lib/client.ts"
      provides: "Configured Sanity client for GROQ queries"
      contains: "createClient"
    - path: "src/sanity/lib/image.ts"
      provides: "Image URL builder for Sanity CDN images"
      contains: "imageUrlBuilder"
    - path: ".env.example"
      provides: "Template for required environment variables"
      contains: "PUBLIC_SANITY_PROJECT_ID"
  key_links:
    - from: "src/sanity/lib/client.ts"
      to: "src/sanity/config.ts"
      via: "imports projectId, dataset, apiVersion"
      pattern: "import.*config"
    - from: "src/sanity/lib/image.ts"
      to: "src/sanity/lib/client.ts"
      via: "uses client for image URL builder"
      pattern: "import.*client"
    - from: "astro.config.mjs"
      to: "@sanity/astro"
      via: "Astro integration registration"
      pattern: "sanity\\("
---

<objective>
Install Sanity CMS packages, configure the @sanity/astro integration, and create the foundational client and image utility modules.

Purpose: Establishes the CMS infrastructure that all content schemas and queries will build upon. Without this foundation, no content management is possible.
Output: Working Sanity integration with client, image helpers, and proper environment variable configuration.
</objective>

<execution_context>
@/Users/andydev/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andydev/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-content-management-system/02-RESEARCH.md

# Existing config files that will be modified
@astro.config.mjs
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Sanity packages and create environment configuration</name>
  <files>package.json, .env, .env.example</files>
  <action>
Install the following npm packages:
```bash
npm install sanity @sanity/astro @sanity/client @sanity/image-url @sanity/vision astro-portabletext
```

Create `.env.example` with the required environment variables (template for the user):
```
# Sanity CMS Configuration (PUBLIC_ prefix = safe for client-side)
PUBLIC_SANITY_PROJECT_ID=your_project_id_here
PUBLIC_SANITY_DATASET=production
```

Create `.env` with the same structure. The user will fill in actual values via user_setup.

Ensure `.env` is in `.gitignore` (check existing .gitignore, add if missing).

Do NOT install `sanity-plugin-dashboard-widget-netlify` or `sanity-plugin-asset-source-cloudinary` — those are optional and can be added later.
  </action>
  <verify>
Run `npm ls sanity @sanity/astro @sanity/client @sanity/image-url astro-portabletext` — all packages listed without errors.
Verify `.env.example` exists and contains PUBLIC_SANITY_PROJECT_ID and PUBLIC_SANITY_DATASET.
Verify `.env` is in `.gitignore`.
  </verify>
  <done>All 6 Sanity packages installed. Environment variable template created. .env gitignored.</done>
</task>

<task type="auto">
  <name>Task 2: Configure Astro integration and create Sanity client utilities</name>
  <files>astro.config.mjs, src/sanity/config.ts, src/sanity/lib/client.ts, src/sanity/lib/image.ts, tsconfig.json</files>
  <action>
**1. Create `src/sanity/config.ts`** — centralized Sanity configuration:
```typescript
export const sanityConfig = {
  projectId: import.meta.env.PUBLIC_SANITY_PROJECT_ID || '',
  dataset: import.meta.env.PUBLIC_SANITY_DATASET || 'production',
  apiVersion: '2026-02-13',
  useCdn: false, // false for static builds — get latest content at build time
};
```

**2. Create `src/sanity/lib/client.ts`** — configured Sanity client:
```typescript
import { createClient } from '@sanity/client';
import { sanityConfig } from '../config';

export const client = createClient({
  ...sanityConfig,
  perspective: 'published', // Only fetch published documents
});
```

**3. Create `src/sanity/lib/image.ts`** — image URL builder:
```typescript
import imageUrlBuilder from '@sanity/image-url';
import type { SanityImageSource } from '@sanity/image-url/lib/types/types';
import { client } from './client';

const builder = imageUrlBuilder(client);

export function urlForImage(source: SanityImageSource) {
  return builder.image(source).auto('format').fit('max');
}
```

**4. Update `astro.config.mjs`** — add @sanity/astro integration and cdn.sanity.io to image domains:
- Import sanity from '@sanity/astro'
- Add `sanity({ projectId: ..., dataset: ..., apiVersion: ..., useCdn: false })` to integrations array (AFTER sitemap)
- Add 'cdn.sanity.io' to the existing `image.domains` array (keep 'res.cloudinary.com')

Use `import.meta.env.PUBLIC_SANITY_PROJECT_ID` and `import.meta.env.PUBLIC_SANITY_DATASET` in the astro config (NOT hardcoded values).

**5. Update `tsconfig.json`** — add path alias for sanity:
Add `"@sanity/*": ["src/sanity/*"]` to compilerOptions.paths.

Do NOT add stega/visual editing config — that's deferred per research recommendations.
  </action>
  <verify>
Run `npm run build` — build succeeds (may warn about missing env vars, but should not error).
Verify `src/sanity/config.ts`, `src/sanity/lib/client.ts`, `src/sanity/lib/image.ts` all exist.
Verify `astro.config.mjs` imports and registers @sanity/astro integration.
Verify `tsconfig.json` has @sanity/* path alias.
Verify `cdn.sanity.io` is in image domains.
  </verify>
  <done>Astro-Sanity integration configured. Client and image utilities created. TypeScript path alias added. Build passes.</done>
</task>

</tasks>

<verification>
1. `npm ls sanity @sanity/astro @sanity/client @sanity/image-url astro-portabletext` — all packages present
2. `npm run build` — completes without errors
3. `.env.example` contains all required env vars
4. `src/sanity/config.ts` exports sanityConfig with projectId, dataset, apiVersion, useCdn
5. `src/sanity/lib/client.ts` creates and exports a configured Sanity client
6. `src/sanity/lib/image.ts` exports urlForImage function using image URL builder
7. `astro.config.mjs` includes @sanity/astro in integrations array
</verification>

<success_criteria>
- All Sanity packages installed and importable
- Sanity client configured with environment-variable-driven project settings
- Image URL builder ready for generating optimized Sanity CDN URLs
- Astro integration registered and build passes
- Environment variable template documented for user setup
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-management-system/02-01-SUMMARY.md`
</output>
