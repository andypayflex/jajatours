---
phase: 03-tour-content
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/sanity/schemaTypes/tour.ts
  - src/sanity/lib/queries.ts
autonomous: true

must_haves:
  truths:
    - "Tour schema supports day-by-day itinerary with dayNumber, title, description, activities, meals, accommodation"
    - "Tour schema supports inclusions and exclusions as string arrays"
    - "Tour schema supports safety info with difficulty level, fitness requirements, risks, equipment, what to bring, certifications"
    - "GROQ detail query projects all new fields including nested itinerary, safetyInfo, inclusions, exclusions"
  artifacts:
    - path: "src/sanity/schemaTypes/tour.ts"
      provides: "Extended tour schema with itinerary, inclusions, exclusions, safetyInfo fields"
      contains: "itinerary"
    - path: "src/sanity/lib/queries.ts"
      provides: "Updated tourBySlugQuery with new field projections"
      contains: "itinerary[]"
  key_links:
    - from: "src/sanity/lib/queries.ts"
      to: "src/sanity/schemaTypes/tour.ts"
      via: "GROQ projections match schema field names"
      pattern: "safetyInfo.*difficultyLevel"
---

<objective>
Extend the Sanity tour schema with itinerary, pricing transparency, and safety fields, then update GROQ queries to project these new fields.

Purpose: The existing tour schema has basic fields (title, pricing, dates) but lacks the structured content needed for detailed tour pages -- day-by-day itineraries, inclusions/exclusions lists, and safety disclosures. These fields must exist in the schema and be queryable before any tour detail components can be built.

Output: Extended tour.ts schema with 4 new field groups, updated tourBySlugQuery with full projections.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tour-content/03-RESEARCH.md
@src/sanity/schemaTypes/tour.ts
@src/sanity/lib/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend tour schema with itinerary, inclusions, exclusions, and safety fields</name>
  <files>src/sanity/schemaTypes/tour.ts</files>
  <action>
Add 4 new field groups to the existing tour schema, inserted AFTER the `body` field and BEFORE `category`:

1. **itinerary** - Array of day objects:
   - `dayNumber` (number, required, min 1)
   - `title` (string, required) -- e.g. "Arrival in Cape Town"
   - `description` (text, 4 rows)
   - `activities` (array of strings) -- e.g. ["Shark cage diving", "Beach walk"]
   - `meals` (object with boolean fields: breakfast, lunch, dinner)
   - `accommodation` (string) -- e.g. "Bush camp" or "Guesthouse"
   - Preview: show "Day {dayNumber}: {title}"

2. **inclusions** - Array of strings, title "What's Included", description "List what is included in the tour price"

3. **exclusions** - Array of strings, title "What's Excluded", description "List what is NOT included in the tour price"

4. **safetyInfo** - Object with:
   - `difficultyLevel` (string, dropdown: Easy/Moderate/Challenging/Strenuous with descriptive titles like "Easy - All fitness levels")
   - `fitnessRequirements` (text, 3 rows)
   - `risks` (array of strings, description "List inherent risks")
   - `equipmentProvided` (array of strings)
   - `whatToBring` (array of strings)
   - `guideCertifications` (text, 2 rows, description "e.g. PADI Divemaster, Wilderness First Responder")

Use the exact field definitions from the research document (Pattern 6). Import nothing new -- `defineType` and `defineField` are already imported.

IMPORTANT: Do NOT nest arrays within arrays directly (Sanity limitation). The itinerary pattern is correct: array of objects where each object contains an `activities` array of strings. This is object-wrapped, not nested arrays.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors in the schema file. Verify the schema file exports a valid Sanity document type with all new fields present.
  </verify>
  <done>
tour.ts contains itinerary (array of day objects), inclusions (string array), exclusions (string array), and safetyInfo (object with difficultyLevel, fitnessRequirements, risks, equipmentProvided, whatToBring, guideCertifications). Build passes without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GROQ queries to project new tour fields</name>
  <files>src/sanity/lib/queries.ts</files>
  <action>
Update the `tourBySlugQuery` to project all new fields added to the schema:

```groq
export const tourBySlugQuery = `*[_type == "tour" && slug.current == $slug && !(_id in path("drafts.**"))][0] {
  _id,
  title,
  "slug": slug.current,
  excerpt,
  mainImage,
  body,
  category,
  duration,
  groupSize,
  pricing,
  inclusions,
  exclusions,
  itinerary[] {
    dayNumber,
    title,
    description,
    activities,
    meals,
    accommodation
  },
  safetyInfo {
    difficultyLevel,
    fitnessRequirements,
    risks,
    equipmentProvided,
    whatToBring,
    guideCertifications
  },
  availableDates[] {
    date,
    spotsAvailable
  },
  publishedAt
}`;
```

Do NOT modify allToursQuery -- it's a listing query that intentionally excludes detail fields for performance (GROQ projection pattern from Phase 2 decisions).

Do NOT modify any blog, gallery, or testimonial queries.
  </action>
  <verify>
Run `npm run build` to confirm no build errors. Grep queries.ts for "itinerary[]" and "safetyInfo" to confirm projections are present.
  </verify>
  <done>
tourBySlugQuery projects itinerary[] with all day fields, safetyInfo with all sub-fields, inclusions, exclusions, and availableDates[]. allToursQuery unchanged. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. tour.ts contains defineField entries for itinerary, inclusions, exclusions, safetyInfo
3. queries.ts tourBySlugQuery includes itinerary[], safetyInfo{}, inclusions, exclusions projections
4. No other queries or schema files modified
</verification>

<success_criteria>
- Tour schema has 4 new field groups (itinerary, inclusions, exclusions, safetyInfo) with proper validation
- tourBySlugQuery projects all new fields with correct GROQ syntax
- Build passes cleanly
- Existing allToursQuery and other queries untouched
</success_criteria>

<output>
After completion, create `.planning/phases/03-tour-content/03-01-SUMMARY.md`
</output>
