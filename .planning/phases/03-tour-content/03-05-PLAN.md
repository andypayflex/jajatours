---
phase: 03-tour-content
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/pages/tours/[slug].pdf.ts
autonomous: true

must_haves:
  truths:
    - "Visitor can download a PDF itinerary for any tour at /tours/{slug}.pdf"
    - "PDF contains tour title, excerpt, day-by-day itinerary, pricing, inclusions/exclusions, and safety info"
    - "PDF is generated at build time via getStaticPaths (no runtime generation)"
    - "PDF endpoint returns proper Content-Type application/pdf with Content-Disposition attachment"
  artifacts:
    - path: "src/pages/tours/[slug].pdf.ts"
      provides: "Static PDF endpoint generating downloadable tour itineraries"
      contains: "getStaticPaths"
      min_lines: 50
  key_links:
    - from: "src/pages/tours/[slug].pdf.ts"
      to: "src/sanity/lib/queries.ts"
      via: "fetch tourBySlugQuery for PDF content"
      pattern: "tourBySlugQuery"
    - from: "src/pages/tours/[slug].pdf.ts"
      to: "pdfkit"
      via: "import PDFDocument for PDF generation"
      pattern: "PDFDocument"
---

<objective>
Create a static PDF endpoint that generates downloadable tour itineraries at build time using PDFKit.

Purpose: This satisfies TOUR-04 (downloadable PDF itinerary). Visitors can download a professional PDF to share or reference offline. PDFs are generated at build time (not client-side) to avoid bundle bloat and work on slow mobile connections.

Output: /tours/{slug}.pdf endpoint generating downloadable PDFs for every tour.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tour-content/03-RESEARCH.md
@.planning/phases/03-tour-content/03-01-SUMMARY.md
@src/sanity/lib/queries.ts
@src/sanity/lib/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PDFKit dependency</name>
  <files>package.json</files>
  <action>
Install PDFKit and its TypeScript types:
```bash
npm install pdfkit @types/pdfkit
```

Use PDFKit (not pdfmake, not Puppeteer). PDFKit is lightweight, supports programmatic PDF creation with text, lists, and basic formatting. Puppeteer would add 250MB+ and require headless Chrome (research anti-pattern).
  </action>
  <verify>
Run `npm ls pdfkit` to confirm installation. Check package.json includes pdfkit dependency.
  </verify>
  <done>
pdfkit and @types/pdfkit are installed and listed in package.json dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PDF endpoint with getStaticPaths</name>
  <files>src/pages/tours/[slug].pdf.ts</files>
  <action>
Create a static Astro endpoint that generates PDF files at build time for each tour.

**Implementation:**

```typescript
import type { APIRoute, GetStaticPaths } from 'astro';
import PDFDocument from 'pdfkit';
import { client } from '../../sanity/lib/client';
import { allToursQuery, tourBySlugQuery } from '../../sanity/lib/queries';

export const getStaticPaths: GetStaticPaths = async () => {
  const tours = await client.fetch(allToursQuery);
  return tours.map((tour: any) => ({
    params: { slug: tour.slug },
  }));
};

export const GET: APIRoute = async ({ params }) => {
  const tour = await client.fetch(tourBySlugQuery, { slug: params.slug });
  if (!tour) {
    return new Response('Tour not found', { status: 404 });
  }

  // Generate PDF
  const doc = new PDFDocument({ margin: 50 });
  const chunks: Uint8Array[] = [];
  doc.on('data', (chunk: Uint8Array) => chunks.push(chunk));

  // --- Header ---
  doc.fontSize(24).font('Helvetica-Bold').text(tour.title, { align: 'center' });
  doc.moveDown(0.5);

  // Meta line: category, duration, group size
  const metaParts: string[] = [];
  if (tour.category) metaParts.push(tour.category);
  if (tour.duration) metaParts.push(tour.duration);
  if (tour.groupSize) metaParts.push(`${tour.groupSize.min}-${tour.groupSize.max} people`);
  if (metaParts.length > 0) {
    doc.fontSize(11).font('Helvetica').fillColor('#555555').text(metaParts.join(' | '), { align: 'center' });
  }
  doc.moveDown(1);

  // Excerpt
  if (tour.excerpt) {
    doc.fontSize(12).font('Helvetica').fillColor('#1A1A1A').text(tour.excerpt);
    doc.moveDown(1);
  }

  // --- Pricing ---
  if (tour.pricing) {
    doc.fontSize(16).font('Helvetica-Bold').fillColor('#2D5016').text('Pricing');
    doc.moveDown(0.3);
    const currencySymbol = tour.pricing.currency === 'ZAR' ? 'R' : tour.pricing.currency + ' ';
    const priceText = `${currencySymbol}${tour.pricing.amount}${tour.pricing.perPerson ? ' per person' : ''}`;
    doc.fontSize(14).font('Helvetica-Bold').fillColor('#1A1A1A').text(priceText);
    doc.moveDown(0.5);
  }

  // Inclusions
  if (tour.inclusions && tour.inclusions.length > 0) {
    doc.fontSize(13).font('Helvetica-Bold').fillColor('#2D5016').text("What's Included");
    doc.moveDown(0.2);
    tour.inclusions.forEach((item: string) => {
      doc.fontSize(11).font('Helvetica').fillColor('#1A1A1A').text(`  ✓  ${item}`);
    });
    doc.moveDown(0.5);
  }

  // Exclusions
  if (tour.exclusions && tour.exclusions.length > 0) {
    doc.fontSize(13).font('Helvetica-Bold').fillColor('#2D5016').text("What's Not Included");
    doc.moveDown(0.2);
    tour.exclusions.forEach((item: string) => {
      doc.fontSize(11).font('Helvetica').fillColor('#1A1A1A').text(`  ✗  ${item}`);
    });
    doc.moveDown(0.5);
  }

  // --- Itinerary ---
  if (tour.itinerary && tour.itinerary.length > 0) {
    doc.moveDown(0.5);
    doc.fontSize(16).font('Helvetica-Bold').fillColor('#2D5016').text('Day-by-Day Itinerary');
    doc.moveDown(0.5);

    tour.itinerary.forEach((day: any) => {
      doc.fontSize(13).font('Helvetica-Bold').fillColor('#D4A843').text(`Day ${day.dayNumber}: ${day.title}`);
      doc.moveDown(0.2);

      if (day.description) {
        doc.fontSize(11).font('Helvetica').fillColor('#1A1A1A').text(day.description);
        doc.moveDown(0.2);
      }

      if (day.activities && day.activities.length > 0) {
        day.activities.forEach((activity: string) => {
          doc.fontSize(11).font('Helvetica').text(`  •  ${activity}`);
        });
        doc.moveDown(0.2);
      }

      // Meals
      if (day.meals) {
        const meals: string[] = [];
        if (day.meals.breakfast) meals.push('Breakfast');
        if (day.meals.lunch) meals.push('Lunch');
        if (day.meals.dinner) meals.push('Dinner');
        if (meals.length > 0) {
          doc.fontSize(10).font('Helvetica-Oblique').fillColor('#555555').text(`Meals: ${meals.join(', ')}`);
        }
      }

      // Accommodation
      if (day.accommodation) {
        doc.fontSize(10).font('Helvetica-Oblique').fillColor('#555555').text(`Accommodation: ${day.accommodation}`);
      }

      doc.moveDown(0.5);
    });
  }

  // --- Safety ---
  if (tour.safetyInfo) {
    doc.fontSize(16).font('Helvetica-Bold').fillColor('#2D5016').text('Safety & Requirements');
    doc.moveDown(0.3);

    if (tour.safetyInfo.difficultyLevel) {
      const labels: Record<string, string> = {
        easy: 'Easy - All fitness levels',
        moderate: 'Moderate - Regular exercise helpful',
        challenging: 'Challenging - Good fitness required',
        strenuous: 'Strenuous - Excellent fitness required',
      };
      doc.fontSize(12).font('Helvetica-Bold').text(`Difficulty: ${labels[tour.safetyInfo.difficultyLevel] || tour.safetyInfo.difficultyLevel}`);
      doc.moveDown(0.2);
    }

    if (tour.safetyInfo.fitnessRequirements) {
      doc.fontSize(11).font('Helvetica').fillColor('#1A1A1A').text(tour.safetyInfo.fitnessRequirements);
      doc.moveDown(0.3);
    }

    if (tour.safetyInfo.whatToBring && tour.safetyInfo.whatToBring.length > 0) {
      doc.fontSize(12).font('Helvetica-Bold').text('What to Bring');
      doc.moveDown(0.2);
      tour.safetyInfo.whatToBring.forEach((item: string) => {
        doc.fontSize(11).font('Helvetica').text(`  •  ${item}`);
      });
      doc.moveDown(0.3);
    }

    if (tour.safetyInfo.guideCertifications) {
      doc.fontSize(12).font('Helvetica-Bold').text('Guide Certifications');
      doc.moveDown(0.2);
      doc.fontSize(11).font('Helvetica').text(tour.safetyInfo.guideCertifications);
    }
  }

  // --- Footer ---
  doc.moveDown(2);
  doc.fontSize(9).font('Helvetica').fillColor('#555555').text('JaJa Tours - South African Adventures', { align: 'center' });
  doc.text('www.jajatours.co.za', { align: 'center' });

  doc.end();

  // Collect PDF buffer
  const pdfBuffer = await new Promise<Buffer>((resolve) => {
    doc.on('end', () => {
      resolve(Buffer.concat(chunks));
    });
  });

  return new Response(pdfBuffer, {
    headers: {
      'Content-Type': 'application/pdf',
      'Content-Disposition': `attachment; filename="${params.slug}-itinerary.pdf"`,
    },
  });
};
```

This follows the research Pattern 2 (Static PDF Endpoint). Key points:
- Uses getStaticPaths to generate PDFs for all tours at build time
- Lightweight PDFKit (not Puppeteer -- avoids 250MB+ bundle)
- Uses built-in Helvetica fonts (no font file loading needed)
- Colors match earth tone design system (#2D5016 primary, #D4A843 accent)
- Handles missing data gracefully (each section checks before rendering)
- Returns proper PDF headers with attachment disposition
  </action>
  <verify>
Run `npm run build` to confirm the PDF endpoint builds without errors. Verify the file exports both getStaticPaths and GET. Check that pdfkit is imported.
  </verify>
  <done>
[slug].pdf.ts generates downloadable PDF itineraries at build time for every tour. PDF includes title, metadata, pricing with inclusions/exclusions, day-by-day itinerary, and safety information. Uses earth tone colors and handles missing content sections. Build passes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. pdfkit is installed in package.json
3. [slug].pdf.ts exports getStaticPaths and GET
4. PDF contains tour title, pricing, itinerary, safety info
5. Response headers include Content-Type: application/pdf and Content-Disposition: attachment
6. Earth tone colors used in PDF (#2D5016 primary green, #D4A843 gold accent)
</verification>

<success_criteria>
- PDFKit installed as dependency
- /tours/{slug}.pdf endpoint generates PDF at build time
- PDF includes: title, category, duration, excerpt, pricing, inclusions/exclusions, itinerary with activities/meals/accommodation, safety info
- Proper HTTP headers for PDF download
- Build passes without errors
- No Puppeteer or heavy PDF dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/03-tour-content/03-05-SUMMARY.md`
</output>
