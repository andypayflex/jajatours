---
phase: 03-tour-content
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/pages/tours/[slug].astro
  - src/components/TourItinerary.astro
  - src/components/TourPricing.astro
  - src/components/TourDates.astro
  - src/components/TourSafety.astro
autonomous: true

must_haves:
  truths:
    - "Visitor can view a tour detail page with hero image, title, duration, category, and rich text body"
    - "Visitor can see a day-by-day itinerary using collapsible CSS-only accordions"
    - "Visitor can see transparent pricing with amount, currency, per-person indicator, inclusions list, and exclusions list"
    - "Visitor can see departure dates with text-based availability indicators (Available, Limited, Sold Out)"
    - "Visitor can read safety information including difficulty level, fitness requirements, risks, equipment, what to bring, and guide certifications"
    - "Tour detail pages are pre-rendered at build time via getStaticPaths"
  artifacts:
    - path: "src/pages/tours/[slug].astro"
      provides: "Dynamic tour detail page with getStaticPaths"
      contains: "getStaticPaths"
      min_lines: 60
    - path: "src/components/TourItinerary.astro"
      provides: "Day-by-day itinerary with details/summary accordions"
      contains: "details"
      min_lines: 30
    - path: "src/components/TourPricing.astro"
      provides: "Pricing display with inclusions and exclusions lists"
      contains: "inclusions"
      min_lines: 30
    - path: "src/components/TourDates.astro"
      provides: "Departure dates with availability badges"
      contains: "spotsAvailable"
      min_lines: 25
    - path: "src/components/TourSafety.astro"
      provides: "Safety info, risks, equipment, certifications"
      contains: "difficultyLevel"
      min_lines: 30
  key_links:
    - from: "src/pages/tours/[slug].astro"
      to: "src/sanity/lib/queries.ts"
      via: "fetch tourBySlugQuery in getStaticPaths and page"
      pattern: "tourBySlugQuery"
    - from: "src/pages/tours/[slug].astro"
      to: "src/components/TourItinerary.astro"
      via: "import and render with tour.itinerary prop"
      pattern: "TourItinerary"
    - from: "src/pages/tours/[slug].astro"
      to: "src/components/TourPricing.astro"
      via: "import and render with tour.pricing, tour.inclusions, tour.exclusions props"
      pattern: "TourPricing"
    - from: "src/pages/tours/[slug].astro"
      to: "src/components/TourDates.astro"
      via: "import and render with tour.availableDates prop"
      pattern: "TourDates"
    - from: "src/pages/tours/[slug].astro"
      to: "src/components/TourSafety.astro"
      via: "import and render with tour.safetyInfo prop"
      pattern: "TourSafety"
---

<objective>
Build the tour detail page with dynamic routing and all content section components (itinerary, pricing, dates, safety).

Purpose: This is the core tour experience page. Visitors see complete tour details including day-by-day itinerary, transparent pricing, departure dates with availability, and safety disclosures. This directly satisfies TOUR-01 (itinerary), TOUR-02 (pricing), TOUR-03 (safety), and TOUR-05 (dates).

Output: Dynamic [slug].astro page with getStaticPaths, plus 4 section components: TourItinerary, TourPricing, TourDates, TourSafety.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tour-content/03-RESEARCH.md
@.planning/phases/03-tour-content/03-01-SUMMARY.md
@src/sanity/lib/queries.ts
@src/sanity/lib/client.ts
@src/sanity/lib/image.ts
@src/layouts/BaseLayout.astro
@src/components/PortableText.astro
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tour section components (TourItinerary, TourPricing, TourDates, TourSafety)</name>
  <files>src/components/TourItinerary.astro, src/components/TourPricing.astro, src/components/TourDates.astro, src/components/TourSafety.astro</files>
  <action>
Create 4 section components for the tour detail page. Each renders a section with `<h2>` heading and content.

**TourItinerary.astro:**
- Props: `{ itinerary: Array<{ dayNumber: number; title: string; description?: string; activities?: string[]; meals?: { breakfast?: boolean; lunch?: boolean; dinner?: boolean }; accommodation?: string }> }`
- Guard: if !itinerary or itinerary.length === 0, render nothing
- Render `<section class="tour-section">` with `<h2>Day-by-Day Itinerary</h2>`
- Each day as `<details>` / `<summary>` accordion (CSS-only, accessible, no JS):
  - `<summary>` contains `<span class="day-label">Day {dayNumber}</span>: {title}`
  - Content div with:
    - Description paragraph (if exists)
    - Activities as `<ul>` (if exists and non-empty)
    - Meals line: show icons/text for included meals (e.g. "Meals: Breakfast, Lunch, Dinner" -- only show included ones)
    - Accommodation line (if exists): "Accommodation: {value}"
- First day `<details open>` to show first day expanded by default
- Styling: details border 1px solid var(--color-text-light) at 20% opacity, border-radius 4px, margin-bottom 0.75rem, padding 0. summary padding 1rem, min-height 44px, cursor pointer, font-weight 600, display flex, align-items center. summary:hover color var(--color-primary). .day-label: font-weight 700, color var(--color-accent), margin-right 0.25rem. .day-content padding 0 1rem 1rem.

**TourPricing.astro:**
- Props: `{ pricing?: { amount: number; currency: string; perPerson: boolean }; inclusions?: string[]; exclusions?: string[] }`
- Guard: if !pricing, render nothing
- Render `<section class="tour-section">` with `<h2>Pricing</h2>`
- Price display: large text showing formatted price. Format: "R{amount}" for ZAR, "{currency} {amount}" otherwise. Add "per person" below if perPerson true.
- If inclusions exist and non-empty: `<div class="inclusions">` with `<h3>What's Included</h3>` + `<ul>` with green checkmark before each item (use CSS ::before with content "\\2713" in green)
- If exclusions exist and non-empty: `<div class="exclusions">` with `<h3>What's Not Included</h3>` + `<ul>` with red X before each item (use CSS ::before with content "\\2717" in red)
- Styling: .price-display font-size 2.5rem, font-weight 700, color var(--color-primary), margin-bottom 0.5rem. .price-unit font-size 1rem, color var(--color-text-light). Lists: list-style none, padding 0. li padding-left 1.75rem, position relative, margin-bottom 0.5rem, min-height 1.5rem. ::before position absolute, left 0.

**TourDates.astro:**
- Props: `{ dates?: Array<{ date: string; spotsAvailable: number }> }`
- Guard: if !dates or dates.length === 0, render nothing
- Render `<section class="tour-section">` with `<h2>Upcoming Departures</h2>`
- Each date as a row showing:
  - Formatted date using `new Date(date).toLocaleDateString('en-ZA', { year: 'numeric', month: 'long', day: 'numeric' })` (outputs "15 June 2026")
  - Availability badge: if spotsAvailable === 0: "Sold Out" (red bg), elif spotsAvailable <= 3: "Limited - {n} spots left" (amber bg), else: "Available - {n} spots" (green bg). Use TEXT labels alongside color (accessibility requirement from research).
- Styling: .date-row display flex, justify-content space-between, align-items center, padding 1rem, border-bottom 1px solid var(--color-text-light) at 10% opacity. Last child no border. .badge display inline-block, padding 0.25rem 0.75rem, border-radius 4px, font-size 0.875rem, font-weight 600. .badge-available bg #d4f4dd color #166534. .badge-limited bg #fef3c7 color #854d0e. .badge-soldout bg #fee2e2 color #991b1b.

**TourSafety.astro:**
- Props: `{ safetyInfo?: { difficultyLevel?: string; fitnessRequirements?: string; risks?: string[]; equipmentProvided?: string[]; whatToBring?: string[]; guideCertifications?: string } }`
- Guard: if !safetyInfo, render nothing
- Render `<section class="tour-section">` with `<h2>Safety & Requirements</h2>`
- Difficulty badge: map value to display label ("easy" -> "Easy - All fitness levels", "moderate" -> "Moderate - Regular exercise helpful", "challenging" -> "Challenging - Good fitness required", "strenuous" -> "Strenuous - Excellent fitness required"). Style as colored badge matching difficulty.
- If fitnessRequirements: paragraph under "Fitness" sub-heading
- If risks and non-empty: `<h3>Risk Disclosures</h3>` + `<ul>` with warning icon (CSS ::before "\26A0" triangle)
- If equipmentProvided and non-empty: `<h3>Equipment Provided</h3>` + `<ul>`
- If whatToBring and non-empty: `<h3>What to Bring</h3>` + `<ul>`
- If guideCertifications: `<h3>Guide Certifications</h3>` + `<p>`
- Styling: consistent with other sections. Difficulty badge uses color coding: easy green, moderate blue, challenging amber, strenuous red.
  </action>
  <verify>
Run `npm run build` to confirm no TypeScript errors across all 4 component files. Verify each file exists and contains its primary content pattern (details, inclusions, spotsAvailable, difficultyLevel).
  </verify>
  <done>
Four section components created: TourItinerary (CSS-only accordions with day details), TourPricing (formatted price + inclusions/exclusions with icons), TourDates (formatted dates with text-based availability badges), TourSafety (difficulty badge + risks + equipment + certifications). All guard against missing data. All follow earth tone design system.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dynamic tour detail page with getStaticPaths</name>
  <files>src/pages/tours/[slug].astro</files>
  <action>
Create the dynamic tour detail page using Astro's static path generation.

**Implementation:**

1. Import all dependencies: BaseLayout, PortableText, TourItinerary, TourPricing, TourDates, TourSafety, client, allToursQuery, tourBySlugQuery, urlForImage

2. Export `getStaticPaths`:
```typescript
export async function getStaticPaths() {
  const tours = await client.fetch(allToursQuery);
  return tours.map((tour: any) => ({
    params: { slug: tour.slug },
  }));
}
```

3. Fetch full tour data in the component:
```typescript
const { slug } = Astro.params;
const tour = await client.fetch(tourBySlugQuery, { slug });
if (!tour) return Astro.redirect('/tours');
```

4. Page structure within BaseLayout (title=tour.title, description=tour.excerpt):
   - **Hero section**: Full-width mainImage (if exists) using urlForImage(tour.mainImage).width(1200).height(500).url(), with alt text. Below image: tour title as `<h1>`, category badge, duration, and group size (e.g. "2-8 people").
   - **Body content**: Render tour.body with PortableText component (if body exists)
   - **Section components** (each only renders if data exists):
     - TourItinerary with itinerary={tour.itinerary}
     - TourPricing with pricing={tour.pricing} inclusions={tour.inclusions} exclusions={tour.exclusions}
     - TourDates with dates={tour.availableDates}
     - TourSafety with safetyInfo={tour.safetyInfo}
   - **CTA section** at bottom:
     - "Interested in this tour?" heading
     - Two buttons side by side on desktop, stacked on mobile:
       - "Inquire Now" link to `/inquiry?tour=${tour.slug}` (primary button style)
       - "Download PDF" link to `/tours/${tour.slug}.pdf` (secondary/outline button style, download attribute)
     - WhatsApp link: `https://wa.me/27XXXXXXXXX?text=${encodeURIComponent(`Hi, I'm interested in the ${tour.title} tour. Can you provide more information?`)}` -- use placeholder number, target="_blank", rel="noopener noreferrer"

5. **Styling (scoped):**
   - `.tour-hero img`: width 100%, max-height 500px, object-fit cover, border-radius 8px (on desktop)
   - `.tour-header`: padding 1.5rem 0, display flex, flex-wrap wrap, gap 0.75rem, align-items center
   - `.tour-meta`: display flex, flex-wrap wrap, gap 1rem, font-size 0.875rem, color var(--color-text-light)
   - `.tour-section`: margin-top 2.5rem, padding-top 2rem, border-top 1px solid var(--color-text-light) at 15% opacity (shared class for all sections)
   - `.tour-body`: margin-top 2rem
   - `.cta-section`: margin-top 3rem, padding 2rem, background var(--color-primary) at 5% opacity, border-radius 8px, text-align center
   - `.cta-buttons`: display flex, gap 1rem, justify-content center, flex-wrap wrap, margin-top 1rem
   - `.btn-primary`: bg var(--color-primary), color white, padding 1rem 2rem, border-radius 4px, font-weight 600, min-height 44px
   - `.btn-secondary`: bg transparent, border 2px solid var(--color-primary), color var(--color-primary), padding 1rem 2rem, border-radius 4px, font-weight 600, min-height 44px
   - `.whatsapp-link`: display inline-flex, color #25D366 (WhatsApp green), font-weight 600, margin-top 1rem
   - Mobile: `.cta-buttons` flex-direction column, align-items stretch
  </action>
  <verify>
Run `npm run build` to confirm the dynamic route builds with getStaticPaths. Verify the file exports getStaticPaths and imports all 4 section components. Check that the page fetches tourBySlugQuery with slug parameter.
  </verify>
  <done>
[slug].astro pre-renders all tour detail pages at build time. Page shows hero image, title with metadata, rich text body, itinerary accordions, pricing with inclusions/exclusions, departure dates with availability, safety info, and CTA section with inquiry link, PDF download link, and WhatsApp chat link. All sections gracefully hidden when data not present.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. [slug].astro exports getStaticPaths fetching all tour slugs
3. All 4 section components imported and rendered conditionally
4. TourItinerary uses details/summary elements (CSS-only accordions)
5. TourDates uses text-based availability labels (not color-only)
6. TourPricing shows inclusions with checkmarks and exclusions with X marks
7. TourSafety displays difficulty level, risks, equipment, certifications
8. CTA section links to /inquiry?tour={slug} and /tours/{slug}.pdf
</verification>

<success_criteria>
- Dynamic tour pages pre-rendered at build time via getStaticPaths
- Hero image, title, category, duration, group size displayed
- Day-by-day itinerary in accessible CSS-only accordions
- Transparent pricing with inclusions/exclusions lists
- Departure dates with text-based availability indicators
- Safety information with difficulty level and risk disclosures
- CTA section with inquiry form link, PDF download, and WhatsApp
- All sections handle missing data gracefully
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/03-tour-content/03-04-SUMMARY.md`
</output>
